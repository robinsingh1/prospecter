/** @jsx React.DOM */

module.exports = React.createClass({displayName: 'exports',
  // Sent Mail
  getInitialState: function() {
    return {
      sentEmails: []
    }
  },

  componentDidMount: function() {
    thiss = this;
    qry = {
      include: 'campaign,prospect,prospect.email_guesses.pattern',
      order:'-createdAt',
      campaign: {
        __type: 'Pointer',
        className:'Campaign',
        objectId: this.props.selectedCampaign.objectId,
      }
    }
    $.ajax({
      url: 'https://api.parse.com/1/classes/SentEmail',
      data: qry,
      headers: appConfig.headers,
      success: function(res) { thiss.setState({sentEmails: res.results}) },
      error: function() {}
    })
  },

  render: function() {
    sentEmails = []
    for(i=0;i< this.state.sentEmails.length; i++) 
      sentEmails.push(SentEmailRow({sentEmail: this.state.sentEmails[i]}))

    return (
      React.DOM.div({style: {overflow:'auto',height:417}}, 
        React.DOM.table({className: "table table-striped", style: {marginBottom:0}}, 
          React.DOM.thead(null, 
            React.DOM.th(null), 
            React.DOM.th(null, "Prospect Name"), 
            React.DOM.th(null, "Prospect Email"), 
            React.DOM.th(null, "Template"), 
            React.DOM.th({style: {width:290}}, "Status")
          ), 
          React.DOM.tbody(null, 
            sentEmails
          )
        )
      )
    );
  }
});

var SentEmailRow = React.createClass({displayName: 'SentEmailRow',
  render: function() {
    sentEmail = this.props.sentEmail
    //console.log(sentEmail)

    email = sentEmail.email
    /*
    if(email == "no_email"){
      first = sentEmail.prospect.name.split(' ')[0]
      last = _.last(sentEmail.prospect.name.split(' '))

      pattern = _.findWhere(sentEmail.prospect.email_guesses, {'tried':false})
      data = {first: first, last: last, fi: first[0], li: last[0]}
      email = Mustache.render(pattern.pattern.pattern, data).toLowerCase()
    }
    */

    replied = "label label-default"
    opened = "label label-default"
    delivered = "label label-default"
    queued = "label label-default"

    if(sentEmail.replied) 
      replied = "label label-success"
    if(sentEmail.opened) 
      opened = "label label-success"
    if(sentEmail.delivered) 
      delivered = "label label-success"
    if(sentEmail.queued) 
      queued = "label label-success"

    return (
      React.DOM.tr(null, 
        React.DOM.td({style: {width:100}}, React.DOM.h6(null, 
            React.DOM.i({className: "fa fa-clock"}), 
            moment(sentEmail.createdAt).fromNow())), 
        React.DOM.td({style: {width:200}}, 
          React.DOM.h6({style: {fontSize:14,fontWeight:'bold',marginBottom:0}}, 
            sentEmail.prospect.name), 
          React.DOM.h6({style: {fontStyle:'italic',marginTop:4,marginBottom:0}}, 
            sentEmail.prospect.pos.trim()), 
          React.DOM.h6({style: {marginTop:4,fontWeight:'bold'}}, 
            React.DOM.i({className: "fa fa-building"}), " ", 
            sentEmail.prospect.company_name)
        ), 
        React.DOM.td({style: {width:200}}, React.DOM.h6(null, email)), 
        React.DOM.td(null, 
          React.DOM.h6(null, 
            React.DOM.i({className: "fa fa-file-text-o"}), " " + ' ' +
            "Template"
          )
        ), 
        React.DOM.td({style: {paddingTop:13}}, 
          React.DOM.span({className: queued}, "Queued"), 
          React.DOM.i({className: "fa fa-chevron-circle-right text-muted", 
             style: {paddingLeft:5,paddingRight:5}}), 
          React.DOM.span({className: delivered}, "Delivered"), 
          React.DOM.i({className: "fa fa-chevron-circle-right text-muted", 
             style: {paddingLeft:5,paddingRight:5}}), 
          React.DOM.span({className: opened}, "Opened"), 
          React.DOM.i({className: "fa fa-chevron-circle-right text-muted", 
             style: {paddingLeft:5,paddingRight:5}}), 
          React.DOM.span({className: replied}, "Replied")
        )
      )
    )
  }
})
