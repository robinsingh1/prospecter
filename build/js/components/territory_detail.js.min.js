/** @jsx React.DOM */

module.exports = React.createClass({displayName: 'exports',
  // SignalDetail
  getInitialState: function() {
    return {
      currentSignal: 'CompanySignal',
      signals: [],
      //allProspected: this.props.currentProfileReport.prospected,
      companyCount: '~',
      peopleCount: '~'
    }
  },

  getSignals: function(currentSignal) {
    var thissss = this;
    currentReport = this.props.currentProfileReport.objectId
    currentProfileReport = appConfig.pointer('SignalReport', currentReport)

    qry = {
      where:JSON.stringify({ report: currentProfileReport }),
      include:'company_signal,company_signal.signals,signals',
      order:'-createdAt',
      limit:100
    }

    $.ajax({
      url: 'https://api.parse.com/1/classes/'+currentSignal,
      data: qry,
      type:'GET',
      headers:appConfig.parseHeaders,
      success: function(res) {
        console.log('SIGNAL DETAIL')
        console.log(res.results)
        console.log('PROFILE REPORT')
        console.log(thissss.props.currentProfileReport.objectId)
        thissss.setState({signals: res.results})
      },
      error: function(err) { console.log(err.responseText) }
    });
  },

  setCompanyState: function() { 
    this.setState({currentSignal: 'CompanySignal'}) 
  }, 
  setPersonState: function() { this.setState({currentSignal: 'PeopleSignal'}) }, 

  componentDidMount: function() {
    console.log(this.props.currentProfileReport.objectId)
    this.getSignals(this.state.currentSignal)
    qry = {
      where:JSON.stringify({ report: currentProfileReport }),
      count: 1
    }
    var thiss = this;
    $.ajax({
      url:'https://api.parse.com/1/classes/PeopleSignal',
      data: qry,
      headers: appConfig.headers,
      success: function(res) { thiss.setState({peopleCount: res.count})},
      error: function(err) { console.log(err.responseText) },
    })

    $.ajax({
      url:'https://api.parse.com/1/classes/CompanySignal',
      data: qry,
      headers: appConfig.headers,
      success: function(res) { thiss.setState({companyCount: res.count})},
      error: function(err) { console.log(err.responseText) },
    })
  },

  componentWillUpdate: function(nextProps, nextState) {
    if(this.state.currentSignal != nextState.currentSignal)
      this.getSignals(nextState.currentSignal)
  },

  returnToCalendarView: function() {
    console.log('return to calendar view')
  },

  render: function() {
    console.log('ALL PROSPECTED')
    console.log(this.state.allProspected)
    console.log('CURRENT SIGNAL')
    console.log(this.state.currentSignal)
    console.log('SIGNAL')
    console.log(this.state.signals)
    signals = []
    for(i=0;i< this.state.signals.length; i++) {
      if(this.state.currentSignal == 'CompanySignal')
        signals.push(CompanyHiringSignalRow({signal: this.state.signals[i], 
                                       allProspected: this.state.allProspected}))
      else
        signals.push(PeopleSignalRow({signal: this.state.signals[i], 
                                       allProspected: this.state.allProspected}))
    }

    currentProfileReport = this.props.currentProfileReport
    companyBtn = (this.state.currentSignal == "CompanySignal") ? "btn btn-xs btn-default active" : "btn btn-xs btn-default"
    peopleBtn = (this.state.currentSignal == "PeopleSignal") ? "btn btn-xs btn-default active" : "btn btn-xs btn-default"
    return (
      React.DOM.div({className: "container", style: {height:356,paddingLeft:0,
                                         paddingRight:0,width:'100%'}}, 
        React.DOM.div({style: {height:44,borderBottom:'solid 1px rgb(221, 221, 221)'}}, 
          React.DOM.h4({onClick: this.returnToCalendarView, 
              style: {float:'left',cursor:'pointer',marginTop:7,fontWeight:200,
                      paddingLeft:20,paddingTop:5,display:'inline-block'}}, 
              
                React.DOM.i({className: "fa fa-calendar", style: {marginRight:5}}), 
                this.props.currentProfile.name
          ), 
          React.DOM.h6({style: {fontSize:13,paddingLeft:5,paddingTop:5,display:'inline-block'}}, 
            React.DOM.i({className: "fa fa-chevron-right", style: {fontSize:9}}), "  ", 
            React.DOM.i({className: "fa fa-clock-o"}), "  ", 
            moment(currentProfileReport.createdAt).fromNow(), "  "
          ), 

          (this.state.allProspected) ?
          React.DOM.a({href: "javascript:", style: {fontWeight:'bold',float:'right',
                                        marginRight:10,marginTop:10}, 
             className: "btn btn-success btn-xs disabled"}, 
            "Prospected"
          ) :
          React.DOM.a({href: "javascript:", style: {fontWeight:'bold',float:'right',
                                        marginRight:10,marginTop:10}, 
             onClick: this.prospectAll, 
             className: "btn btn-success btn-xs"}, 
            "Prospect All"
          ), 
          

          React.DOM.div({className: "btn-group", 
               style: {float:'right',marginTop:10,marginRight:10}, 
               'data-toggle': "buttons"}, 
            React.DOM.label({className: peopleBtn, style: {width:50}, 
                 onClick: this.setPersonState}, 
              React.DOM.input({type: "checkbox"}), 
              React.DOM.i({className: "fa fa-user"}), "  ", 
              this.state.peopleCount
            ), 
            React.DOM.label({className: companyBtn, style: {width:50}, 
              onClick: this.setCompanyState}, 
              React.DOM.input({type: "checkbox"}), 
              React.DOM.i({className: "fa fa-building"}), "  ", 
              this.state.companyCount
            )
          )
        ), 

        React.DOM.div({className: "col-md-12", style: {paddingLeft:0,paddingRight:0}}, 
          React.DOM.div({style: {overflow:'auto',height:356}}, 
            React.DOM.table({className: "table table-striped"}, 
              React.DOM.thead(null, 
                React.DOM.th({style: {textAlign:'center',width:90}}, 
                  React.DOM.i({className: "fa fa-clock-o"})
                ), 

                React.DOM.th({style: {width:200}}, 
                  (this.state.currentSignal == 'CompanySignal') ?  
                    "Companies" : "People"
                ), 


                React.DOM.th(null, "Source "), 

                React.DOM.th({style: {width:90,textAlign:'center'}}, " ")

              ), 
              React.DOM.tbody({className: "reports"}, 
                signals
              )
            )
          )
        )
      )
    );
  },
  prospectAll: function() {
    console.log(this.state.currentSignal)
    console.log(this.props.currentProfileReport.objectId)
    report_id = this.props.currentProfileReport.objectId
    var thiss = this;
    $.ajax({
      //url: 'http://127.0.0.1:5000/signal_to_prospect',
      url: 'https://nameless-retreat-3525.herokuapp.com/signal_to_prospect',
      data: {all_signals:true, report_id: report_id, 
             signal_type: thiss.state.currentSignal},
      success: function(res) { console.log(res)},
      error: function(err) { console.log(err.responseText)},
    })
  }
});

var CompanyHiringSignalRow = React.createClass({displayName: 'CompanyHiringSignalRow',
  render: function() {
    //console.log(company)
    company = (this.props.signal) ? this.props.signal : {}
    return (
      React.DOM.tr({style: {}}, 
        React.DOM.td({style: {textAlign:'center',width:120}}, 
          React.DOM.h6(null, 
            moment(this.props.signal.createdAt).fromNow()
          )
        ), 

        React.DOM.td(null, 
          React.DOM.h6(null, company.name), 
          React.DOM.h6(null, company.revenue), 
          React.DOM.h6(null, React.DOM.a({href: "javascript:"}, company.websiteUrl)), 
          React.DOM.h6(null, company.city)
        ), 

        React.DOM.td(null, 
          moment(company.timestamp).format('ll')
        ), 

        React.DOM.td(null, 
          (this.props.allProspected) ? 
          React.DOM.a({href: "javascript:", className: "btn btn-success btn-xs disabled", 
            style: {fontWeight:'bold'}}, 
            "Prospected"
          ) : React.DOM.a({href: "javascript:", className: "btn btn-success btn-xs", 
                  onClick: this.turnCompanySignalToProspect, 
            style: {fontWeight:'bold'}}, 
            "Prospect"
          )
        )
      )
    )
  },
  turnCompanySignalToProspect: function() {
    var thiss = this;
    $.ajax({
      //url: 'https://nameless-retreat-',
      //url: 'http://127.0.0.1:5000/signal_to_prospect',
      url: 'https://nameless-retreat-3525.herokuapp.com/signal_to_prospect',
      data: {all_signals:false, signal_id: company.objectId,
             signal_type: 'CompanySignal'},
      success: function(res) { console.log(res)},
      error: function(err) { console.log(err.responseText)},
    })
  }
})

var PeopleSignalRow = React.createClass({displayName: 'PeopleSignalRow',
  turnSignalIntoProspect: function() {
    var thiss = this;
    console.log(this.props.signal)
    $.ajax({
      //url:'http://127.0.0.1:5000/signal_to_prospect',
      url:'http://nameless-retreat-3525.herokuapp.com/signal_to_prospect',
      data: {signal_id: thiss.props.signal.objectId, signal_type:'PeopleSignal',
             all_signals:false},
      success: function(res) { console.log(res) },
      error: function(err) { console.log(err.responseText) } 
    })
  },

  render: function() {
    //console.log(company)
    people = (this.props.signal) ? this.props.signal : {}
    company = people.company_signal
    title = (people.title) ? people.title.split('-')[1] : ""
    title = title.split(' at')[0]
    //city = people.split('-')[0]
    city = ""
    console.log(people)
    return (
      React.DOM.tr({style: {}}, 
        React.DOM.td({style: {textAlign:'center',width:120}}, 
          React.DOM.h6(null, 
            moment(this.props.signal.createdAt).fromNow()
          )
        ), 

        React.DOM.td(null, 
          React.DOM.h6(null, people.link_text + " - ", " ", React.DOM.span({style: {fontStyle:'italic'}}, 
              title)), 
          React.DOM.h6(null, React.DOM.a({href: "javascript:"}, company.websiteUrl)), 
          React.DOM.h6(null, company.name), 
          React.DOM.h6(null, company.city)
        ), 

        React.DOM.td(null, 
          React.DOM.h6(null, company.signals[0].className), 
          React.DOM.h6(null, company.signals[0].job_title), 
          React.DOM.h6(null, company.signals[0].summary)
        ), 
        React.DOM.td(null, 
          company.timestamp, 
          moment(company.timestamp).format('ll')
        ), 

        React.DOM.td(null, 
          (this.props.allProspected) ? 
          React.DOM.a({href: "javascript:", className: "btn btn-success btn-xs disabled", 
            style: {fontWeight:'bold'}}, 
            "Prospected"
            ) : React.DOM.a({href: "javascript:", className: "btn btn-success btn-xs", 
                      onClick: this.turnSignalIntoProspect, 
            style: {fontWeight:'bold'}}, 
            "Prospect"
          )
          
        )
      )
    )
  }
})
