/** @jsx React.DOM */

var CompanyProspect = require('./company.js.min.js');
var LoadingSpinner = require('./loading_spinner.js.min.js')
var SideMenuProspects = require('./side_menu_user_prospects.js.min.js');

module.exports = React.createClass({displayName: 'exports',
  getInitialState: function() {
    return {  prospects   : [],
              currentPage : 1,
              loading     : true,
              pages       : 1,
              count       : "~", }
  },
  /*
   *
    cid = this.props.prospect.profile.split('?')[0].split('/company/')[1]
    console.log(this.props)
    window.open("https://www.linkedin.com/vsearch/p?f_CC="+cid)
  */
  
  render: function() {
    console.log('company')
    prospects = []
    for(i=0;i<this.state.prospects.length;i++) {
      url = this.state.prospects[i].url

      if(url != "no linkedin website" && typeof(url) != "undefined" && url != ""){
        url = url.replace('http://','')
        the_link = React.DOM.a({href: 'http://'+url}, React.DOM.i({className: "fa fa-globe"}))
      } else {
        the_link = ""
      }

      profile = this.state.prospects[i].profile
      //profile = profile.replace('http://','')
      li = React.DOM.a({href: 'http://'+profile}, React.DOM.i({className: "fa fa-linkedin-square"}))

      if(this.props.prospectType == 'Prospect') {
        prospects.push(
          UserProspect({deleteProspect: this.deleteProspect, 
                        prospect: this.state.prospects[i], 
                        key: this.generate_id(), 
                        link: the_link, li: li})
        )
      } else {
        prospects.push(
          CompanyProspect({deleteProspect: this.deleteProspect, 
                           key: this.generate_id(), 
                           prospect: this.state.prospects[i]})
        )
      }
    }

    previous = (this.state.currentPage - 1) ? '' : 'disabled'
    forward = (this.state.currentPage == this.state.pages) ? 'disabled' : ''

    lowerLimit = (this.state.currentPage-1)*100
    upperLimit = this.state.currentPage*100

    lowerLimit = (lowerLimit) ? lowerLimit : 1
    upperLimit = (upperLimit > this.state.count) ? this.state.count : upperLimit
  
    console.log(prospects.length)
    companyStyle= (prospects.length) ? {padding:'0'} : {display:'none'}

    return (
      React.DOM.div(null, 
      React.DOM.div({className: "container bg-radius", style: {width:'100%',padding:'0'}}, 
        (prospects.length == 0 && this.state.loading == false) ? EmptyCompanyProspectsPanel(null) : "", 
        (this.state.loading) ? LoadingSpinner(null) : "", 
        React.DOM.div({className: "col-md-12", style: companyStyle}, 
          React.DOM.div({id: "autoscroll", style: {height:'400px',overflow:'auto'}}, 
            React.DOM.table({className: "table table-striped"}, 
              React.DOM.thead({style: {backgroundColor:'white'}}, 
                CompanyProspectHeader(null)
              ), 
              React.DOM.tbody(null, 
                prospects
              )
            )
          )
        )
      ), 
        React.DOM.div({className: "panel-footing", id: "navbar", style: {height:'35px',padding:'0px',paddingTop:'7px'}}, 
          React.DOM.span({style: {float:'right',marginRight:'20px'}}, 
          React.DOM.a({href: "javascript:", style: {marginRight:'5px'}, onClick: this.paginatePrevious, className: "blue-gradient btn btn-primary btn-xs " + previous}, React.DOM.i({className: "fa fa-fast-backward"})), 
          React.DOM.a({href: "javascript:", onClick: this.paginatePrevious, className: "blue-gradient btn btn-primary btn-xs " + previous}, React.DOM.i({className: "fa fa-chevron-left"})), 
          "   ", 
          React.DOM.span({className: ""}, lowerLimit + ' - '+upperLimit+' of '+this.state.count), 
          "   ", 
          React.DOM.a({href: "javascript:", onClick: this.paginateForward, className: "blue-gradient btn btn-primary btn-xs " + forward}, React.DOM.i({className: "fa fa-chevron-right"})), 
          React.DOM.a({href: "javascript:", style: {marginLeft:'5px'}, onClick: this.paginateForward, className: "blue-gradient btn btn-primary btn-xs " + forward}, React.DOM.i({className: "fa fa-fast-forward"}))
          )
        )
      )
    );
  },

  componentDidMount: function() {
    thisss = this;
    parse_headers = {'X-Parse-Application-Id':'N85QOkteEEQkuZVJKAvt8MVes0sjG6qNpEGqQFVJ', 'X-Parse-REST-API-Key':'VN6EwVyBZwO1uphsBPsau8t7JQRp00UM3KYsiiQb'}
    company = JSON.stringify(JSON.parse(localStorage.currentUser).company)

    $.ajax({
      url: 'https://api.parse.com/1/classes/CompanyProspect',
      type:'GET',
      headers: parse_headers,
      async: true,
      data: 'where={"company":'+company+'}&count=1&order=-createdAt',
      success: function(res){
        thisss.setState({prospects: res.results})
        thisss.setState({count: res.count})
        thisss.setState({pages: Math.ceil(res.count/100)})
        thisss.setState({loading: false})
      },
      error: function(res){
        console.log('error')
        console.log(res)
      }
    });
  },

  generate_id : function () {
    return '_' + Math.random().toString(36).substr(2, 9);
  },
});

var SideMenuCompanyProspects = React.createClass({displayName: 'SideMenuCompanyProspects',
  render: function() {
        
    return (
      React.DOM.div({className: "col-md-2", style: {padding:'0',height:'400px',backgroundColor:'#e0e9ee',borderRight:'1px solid #b0b8bf',textAlign:'center'}}, 
        React.DOM.div({className: "prospect-list-header"}, 
          "Lists"
        ), 
        React.DOM.div({className: "btn-group-vertical", style: {width:'100%'}}, 
          React.DOM.button({type: "button", className: "list-names btn btn-default"}, "Templates"), 
          React.DOM.button({type: "button", className: "list-names btn btn-default"}, "Schedules"), 
          React.DOM.button({type: "button", className: "list-names btn btn-default"}, "Rules")
        ), 
        React.DOM.br(null), 
        React.DOM.br(null), 
        React.DOM.a({href: "javascript:", className: "btn btn-primary", 
              style: { backgroundImage: 'linear-gradient(180deg, #0096ff 0%, #005dff 100%)'}}, 
          React.DOM.i({className: "fa fa-plus-circle"}), " New Class"
        ), 
        React.DOM.br(null)
      )
    );
  },

  paginatePrevious: function() {
    console.log('previous')
    console.log((this.state.currentPage - 1)*100)
    thiss = this;
    $.ajax({
      url: 'https://api.parse.com/1/classes/Prospect?skip='+(thiss.state.currentPage-2)*100,
      type:'GET',
      headers: parse_headers,
      data: 'where={"company":'+company+'}&count=1',
      success: function(res){
        thiss.setState({prospects: res.results})
        thiss.setState({currentPage: thiss.state.currentPage - 1})
      },
      error: function(res){
        console.log(res)
      }
    });
  },

  paginateForward: function() {
    console.log('forward')

    thiss = this;
    $.ajax({
      url: 'https://api.parse.com/1/classes/Prospect?skip='+thiss.state.currentPage*100,
      type:'GET',
      headers: parse_headers,
      data: 'where={"company":'+company+'}&count=1',
      success: function(res){
        thiss.setState({prospects: res.results})
        thiss.setState({currentPage: thiss.state.currentPage + 1})
      },
      error: function(res){
        console.log(res)
      }
    });
  },
});

var EmptyCompanyProspectsPanel = React.createClass({displayName: 'EmptyCompanyProspectsPanel',
  openLinkedinWindow: function() {
    window.open('https://www.linkedin.com/vsearch/c?type=companies')
  },

  render: function() {
    return (
      React.DOM.div({className: "col-md-offset-3 col-md-6", style: {height:400}}, 
      React.DOM.div({className: "panel panel-default", style: {marginTop:100,height:200}}, 
        React.DOM.div({className: "panel-body"}, 
          React.DOM.h1({className: "lead", style: {textAlign:'center'}}, "Start Prospecting On Linkedin"), 
          React.DOM.a({href: "javascript:", onClick: this.openLinkedinWindow, className: "btn btn-success", style: {backgroundImage: 'linear-gradient(180deg, #0096ff 0%, #005dff 100%) !important',display:'block',marginRight:'auto',marginLeft:'auto',width:200, marginTop:50}}, 
            React.DOM.i({className: "fa fa-search"}), "  " + ' ' +
            "Search for companies!")
        )
      )
    )
    );
  }
});

var CompanyProspectHeader = React.createClass({displayName: 'CompanyProspectHeader',
  render: function() {
    return (
      React.DOM.tr(null, 
        React.DOM.th(null, "Name"), 
        React.DOM.th(null, "Added On"), 
        React.DOM.th(null, "Industry"), 
        React.DOM.th(null, "# of Prospects"), 
        React.DOM.th(null, "Signals"), 
        React.DOM.th(null, " "), 
        React.DOM.th(null, " ")
      )
    );
  }
});
